steps:
  - task: GoTool@0
    inputs:
      version: '1.21.5'
  - bash: |
      git show --stat
      echo $REGISTRY_PASSWORD | docker login $REGISTRY_URL -u $REGISTRY_USERNAME --password-stdin
      export IMAGE_REGISTRY=$REGISTRY_URL
      USER="cloudtest"
      if [[ -n "${RELEASE_PIPELINE:-}" ]]; then
        USER="vsts"
      fi
      export GOPATH="/home/${USER}/go"
      export PATH="${PATH}:${GOPATH}/bin"

      if [[ ! -d kubetest2-aks ]]; then
        git clone https://github.com/kubernetes-sigs/cloud-provider-azure.git
        cp -r cloud-provider-azure/kubetest2-aks .
        rm -rf cloud-provider-azure
      fi
      pushd kubetest2-aks
      go get -d sigs.k8s.io/kubetest2@latest
      go install sigs.k8s.io/kubetest2@latest
      go mod tidy
      make deployer
      sudo GOPATH="/home/${USER}/go" make install
      popd

      export IMAGE_TAG="$(git describe --tags --match "v[0-9].*")"
      kubetest2 aks --build --target cnm --targetPath `pwd`
    displayName: make and push cnm image
    env:
      REGISTRY_URL: $(registry.url)
      REGISTRY_USERNAME: $(registry.username)
      REGISTRY_PASSWORD: $(registry.password)
